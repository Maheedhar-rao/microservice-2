 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lender Portal</title>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to right, #ad2656, #4579b6);
            text-align: center;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 40px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.4);
            color: black;
        }
        h1 {
            color: #3271af;
            font-size: 26px;
            margin-bottom: 20px;
        }
        .lender-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        .lender {
            padding: 14px;
            background: linear-gradient(to right, #56ab2f, #a8e063);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease-in-out;
            word-break: break-word;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .lender:hover {
            background: #45a049;
            transform: scale(1.08);
        }
        .selected {
            background: #ff4757;
            color: white;
            border: 2px solid #e84118;
        }
        textarea, input[type='text'] {
            width: 100%;
            max-width: 600px;
            display: block;
            margin: 0 auto;
            padding: 14px;
            font-size: 16px;
            text-align: left;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: 2px solid #1e90ff;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            text-align: center;
        }
        .submit-btn {
            margin-top: 20px;
            padding: 14px 24px;
            background: linear-gradient(to right, #ff512f, #dd2476);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
        }
        .submit-btn:hover {
            background: #ff4757;
            transform: scale(1.08);
        }
        .summary {
            margin-top: 20px;
            color: #c0392b;
            font-weight: bold;
        }
        .file-upload {
            padding: 20px;
            border: 2px dashed #1e90ff;
            border-radius: 8px;
            margin-top: 15px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .file-upload:hover {
            background: #f1f1f1;
        }
    </style>
</head>
<body>
    <!--<img src="croc.PNG" alt="Lender Portal Logo" style="max-width: 100px; height: auto; display: block; margin: 0 auto 20px;">-->

    <div class="container">
        <h1>Submission dashboard</h1>
        
        <label for="business-name" style="display: block; font-weight: bold; margin-bottom: 5px;">Business Name *</label>
        <input type="text" id="business-name" required>
        
        <h3>Select Lenders</h3>
        <div class="lender-grid" id="lender-grid"></div>

        <h3>Attach the files here</h3>
        <div class="file-upload" onclick="document.getElementById('file-upload').click();">Drag & Drop or Click to Upload</div>
        <input type="file" id="file-upload" accept=".pdf,.doc,.docx,.jpg,.png" multiple hidden>
        <p>File limit: 25MB</p>
        <div id="file-list"></div>
        
        <h3>Adjust your message to your lenders</h3>
        <textarea id="message-box" style="height: 120px;">Good afternoon, Please review this file for underwriting. Thank you.</textarea>
        
        <div class="summary">
            <h3>You're about to submit to the following lenders:</h3>
            <p id="selected-lenders" style="white-space: pre-line; text-align: center; font-weight: bold;"></p>
        </div>
        
        <button class="submit-btn" onclick="submitForm()">Submit</button>
    </div>

    <script>
        const lenders = [
  "Test",
  "Alternative",
  "American Choice",
  "Arena",
  "Aspire Funding",
  "Amsterdam Capital",
  "Barclays",
  "BCA Business Cash Adv",
  "BC Providers",
  "Biz2Credit",
  "Broadway Advance",
  "Capital Assist",
  "Capital Domain",
  "Capybara",
  "Capytal/Newco",
  "Cashable",
  "Cashfloit",
  "Cobalt",
  "Clear Fund/Litefund",
  "Stone Street",
  "Cromwell Capital",
  "E Advance",
  "Eminent",
  "Equita",
  "Everest/Vader/Granite",
  "Family business fund",
  "Fenix",
  "Finpoint",
  "Fintap",
  "Fundnow",
  "Fundfi",
  "Fundpro",
  "Fundkite",
  "Fundr",
  "Fundworks",
  "Fundomate",
  "G&G",
  "GFE",
  "Green Note",
  "Highland Hill",
  "Highpower",
  "Honest",
  "IOU",
  "Insta funders",
  "Jaffe",
  "JRG Funding",
  "Kapitus",
  "Kalamata Capital",
  "Legend",
  "Legendary",
  "Last Chance",
  "LendBug",
  "Libertas",
  "Lifetime",
  "Lily Advance",
  "md Capital",
  "Meged",
  "Merchant marketplace",
  "Mint",
  "Merit",
  "MNY",
  "MNR Capital",
  "Moneywell",
  "Mr.Advance",
  "Nitro Advance",
  "Ocean",
  "Overton",
  "QFS",
  "Quikstone",
  "Radiance",
  "Rapid",
  "RBLX",
  "Right Away Capital",
  "Rocket Cap",
  "Rowan",
  "SFS",
  "Smart Step",
  "Smarter Merchant",
  "Spartan",
  "Superfast Cap",
  "Torro",
  "TVT",
  "Velocity",
  "Vivian",
  "Vox",
  "Wall",
  "Wellen",
  "Zinch Fin",
  "501 Advance",
  "Wynwood",
  "WG Financing",
  "PORTALS",
  "ARF Funding (LoC)",
  "Torro SLOC",
  "Harvest SBF (Asset)",
  "Loanbud (Asset)",
  "Maxim (Asset)",
  "WBL (Asset)",
  "Athas (Asset)",
  "Velocity Mortgage (Asset)",
  "Commercial Loan Center (Asset)",
  "AFG (Equip)",
  "Lendspark (Equip)",
  "Amerifactors (AR)",
  "Bankers Factoring (AR)",
  "Bayview (AR)",
  "Riviera (AR)",
  "Seacoast (AR)",
  "OGF (Term)",
  "Shield Advisory (Term)",
  "Ultum (Term)",
  "Value Capital (Term)",
  "Wing lake (Term)",
  "WG Finanacing",
  "ART Funding",
  "Bluebridge",
  "Bow Apple",
  "FND",
  "Fratello",
  "Instafunders",
  "Nexi",
  "Ora Capital",
  "RBR",
  "Silverline"
];

        const lenderGrid = document.getElementById('lender-grid');
        lenders.forEach(lender => {
            const div = document.createElement('div');
            div.classList.add('lender');
            div.textContent = lender;
            div.onclick = function() {
                div.classList.toggle('selected');
                updateSelectedLenders();
            };
            lenderGrid.appendChild(div);
        });

        function updateSelectedLenders() {
            const selected = [...document.querySelectorAll('.lender.selected')].map(el => el.textContent);
            document.getElementById('selected-lenders').innerHTML = selected.length ? selected.join('<br>') : 'None selected';
        }
        const selectedFiles = [];

        document.getElementById('file-upload').addEventListener('change', function(event) {
    const files = Array.from(event.target.files);
    let totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);

    for (let file of files) {
        totalSize += file.size;
        
        // Prevent total size exceeding 25MB
        if (totalSize > 25 * 1024 * 1024) {
            alert('Total file size exceeds 25MB. Please remove some files.');
            return;
        }

        selectedFiles.push(file);
    }

    document.getElementById('file-upload').value = ''; // Reset file input
    updateFileList();
});


function updateFileList() {
    const fileListDiv = document.getElementById('file-list');
    fileListDiv.innerHTML = ''; // Clear previous files

    selectedFiles.forEach((file, index) => {
        const listItem = document.createElement('div');
        listItem.style.display = 'flex';
        listItem.style.alignItems = 'center';
        listItem.style.justifyContent = 'center';
        listItem.style.marginBottom = '8px';
        listItem.style.fontSize = '14px';
        listItem.style.fontWeight = 'bold';

        // Display image preview if it's an image
        if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.width = '50px';
            img.style.height = '50px';
            img.style.borderRadius = '6px';
            img.style.marginRight = '10px';
            img.onload = () => URL.revokeObjectURL(img.src);
            listItem.appendChild(img);
        }

        // File name
        const fileName = document.createElement('span');
        fileName.textContent = file.name;
        listItem.appendChild(fileName);

        // Remove Button (❌)
        const removeBtn = document.createElement('span');
        removeBtn.innerHTML = ' ❌';
        removeBtn.style.cursor = 'pointer';
        removeBtn.style.color = 'red';
        removeBtn.style.marginLeft = '10px';
        removeBtn.onclick = function () {
            selectedFiles.splice(index, 1);
            updateFileList();
        };
        listItem.appendChild(removeBtn);

        fileListDiv.appendChild(listItem);
    });
}


function submitForm() {
    const businessName = document.getElementById('business-name').value;
    const selectedLenders = [...document.querySelectorAll('.lender.selected')].map(el => el.textContent);
    const message = document.getElementById('message-box').value;
    const submitButton = document.querySelector('.submit-btn');

    if (!businessName) {
        alert('Please enter a business name.');
        return;
    }

    if (selectedLenders.length === 0) {
        alert('Please select at least one lender.');
        return;
    }

    // Disable the button & show processing state
    submitButton.disabled = true;
    submitButton.style.background = '#ccc';
    submitButton.textContent = 'Hold On...';

    const formData = new FormData();
    formData.append('businessName', businessName);
    formData.append('enteredData', message);
    selectedLenders.forEach(lender => formData.append('selectedOptions', lender));

    for (let file of selectedFiles) {
        formData.append('attachments', file);
    }

    fetch('/send-email', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.message === 'Submission successful!') {
            alert('Submission successful! Redirecting to Thank You page...');
            window.location.href = '/thankyou.html';  // Redirect to Thank You page
        } else {
            alert('Something went wrong! Please try again.');
            submitButton.disabled = false;
            submitButton.style.background = 'linear-gradient(to right, #ff512f, #dd2476)';
            submitButton.textContent = 'Submit';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting. Please try again.');
        submitButton.disabled = false;
        submitButton.style.background = 'linear-gradient(to right, #ff512f, #dd2476)';
        submitButton.textContent = 'Submit';
    });
}
// ⬇️ Auto-match logic from localStorage
fetch('test.json') // Adjust this path based on where you serve the JSON
  .then(res => res.json())
  .then(funderRules => {
    const borrower = JSON.parse(localStorage.getItem('borrowerData')) || {};
    const fico = parseInt(borrower.fico || 0);
    const rev = parseInt((borrower.revenue && borrower.revenue !== '-' ? borrower.revenue : borrower.amount || '0').replace(/[^0-9]/g, ''));
    const tib = parseInt(borrower.tib_months || (borrower.tib?.match(/\d+/)?.[0] ?? 0));
    const industry = (borrower.industry || '').toLowerCase();
    const state = (borrower.state || '').toUpperCase();

    console.log('Borrower:', { fico, rev, tib, industry, state });

    document.querySelectorAll('.lender').forEach(el => {
      const name = el.textContent.trim().replace(/\s+/g, '').replace(/[^a-zA-Z]/g, '');

      const funder = Object.entries(funderRules).find(([key]) => 
        key.toLowerCase().replace(/[^a-z]/g, '') === name.toLowerCase()
      );
      if (!funder) return;

      const [lenderName, rule] = funder;

      const minFICO = rule.minFICO || 0;
      const minRev = rule.minRevenueMonthly || 0;
      const minTIB = rule.minTIB || 0;

      const industryPass = !((rule.restrictedIndustries || []).some(r => industry.includes(r.toLowerCase())));
      const statePass = !((rule.restrictedStates || []).includes(state));

      let conditionalDecline = false;
      if (rule.conditionalDeclineRules) {
        for (let cond of rule.conditionalDeclineRules) {
          const i = (cond.industry || '').toLowerCase();
          if (industry.includes(i)) {
            if (cond.revenueLT && rev < cond.revenueLT) {
              conditionalDecline = true;
              break;
            }
          }
        }
      }

      if (fico >= minFICO && rev >= minRev && tib >= minTIB && industryPass && statePass && !conditionalDecline) {
        el.classList.add('selected');
      }
    });
  })
  .catch(err => console.error('Auto-match fetch error:', err));
</script>
</body>
</html>
